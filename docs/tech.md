# 技术设计文档 (TDD): Polymarket 监控机器人 (Supabase 版)

**项目名称**: Polymarket Smart Money Monitor  
**版本**: v1.1.0 (Supabase Integrated)  
**日期**: 2025-12-04  
**技术栈**: Node.js, TypeScript, Ethers.js v6, Axios, Supabase, Node-Telegram-Bot-API

---

## 1. 系统架构设计

### 1.1 架构图 (Mermaid)

```mermaid
graph TD
    User((用户)) -->|/add, /remove| Bot[Telegram Bot Service]
    Bot -->|CRUD| Supabase[(Supabase DB)]
    Bot -->|同步更新| Memory[内存缓存 Watchlist]

    Chain[Polygon Chain] -->|WSS Event| Monitor[Blockchain Listener]
    Supabase -.->|启动时加载| Memory
    Memory -->|快速匹配 (O(1))| Monitor

    Monitor -->|命中监控地址| Logic[Core Logic Processor]
    Logic -->|1. 触发信号| Queue[Task Queue]

    Queue -->|2. 延迟 & 重试| API_Client[Polymarket API Client]
    API_Client -->|3. 请求交易详情| PolyAPI[Polymarket Data API]

    API_Client -->|4. 解析数据| Formatter[Message Formatter]
    Formatter -->|5. 发送通知| Bot
1.2 架构变更说明
持久化层：移除本地 JSON 文件，采用 Supabase (PostgreSQL) 存储监控地址。

缓存策略 (Read-Through)：

链上监听是非常高频的操作（每秒可能有几十个事件），直接查询数据库会导致延迟和 IO 瓶颈。

解决方案：系统启动时将 Supabase 中的数据全量加载到本地内存 (Set 或 Map)。当用户通过 Bot 添加/删除地址时，同时更新 Supabase 和本地内存。

2. 数据库设计 (Supabase Schema)
需要在 Supabase 的 SQL Editor 中执行以下建表语句。

2.1 表结构：monitored_wallets
用于存储需要监控的钱包地址。

SQL

-- 创建监控地址表
CREATE TABLE monitored_wallets (
    id bigint generated by default as identity primary key,
    address text NOT NULL,         -- 钱包地址 (建议存储为小写)
    name text,                     -- 用户备注 (如: "Smart Money 1")
    created_at timestamp with time zone default timezone('utc'::text, now()) not null,

    -- 约束：同一个地址不需要重复监控
    CONSTRAINT unique_address UNIQUE (address)
);

-- 创建索引以优化查询 (虽然主要靠内存，但DB层面也要规范)
CREATE INDEX idx_wallets_address ON monitored_wallets(address);
2.2 环境变量配置 (.env)
Ini, TOML

# Supabase Configuration
SUPABASE_URL=[https://your-project-id.supabase.co](https://your-project-id.supabase.co)
SUPABASE_KEY=your-anon-key-or-service-role-key

# Other config
POLYGON_WSS=wss://polygon-bor.publicnode.com
TELEGRAM_BOT_TOKEN=your-bot-token
3. 核心模块详细设计
3.1 数据库服务模块 (SupabaseService)
封装 Supabase Client 的操作，实现单例模式。

依赖: @supabase/supabase-js

方法:

loadAll(): 启动时获取所有数据，返回 Map<address, name>。

addWallet(address, name): 插入数据，处理重复键错误。

removeWallet(address): 删除数据。

代码逻辑示意:

TypeScript

import { createClient } from '@supabase/supabase-js';

const supabase = createClient(process.env.SUPABASE_URL!, process.env.SUPABASE_KEY!);

export const WatchlistStore = {
  // 内存缓存
  cache: new Map<string, string>(),

  // 初始化：从 DB 加载到 Cache
  async init() {
    const { data, error } = await supabase
      .from('monitored_wallets')
      .select('address, name');

    if (error) throw error;

    data.forEach(row => {
      this.cache.set(row.address.toLowerCase(), row.name);
    });
    console.log(`Loaded ${this.cache.size} wallets from Supabase.`);
  },

  // 添加：写 DB + 写 Cache
  async add(address: string, name: string) {
    const lowerAddr = address.toLowerCase();

    // 1. 写入 Supabase
    const { error } = await supabase
      .from('monitored_wallets')
      .upsert({ address: lowerAddr, name: name }, { onConflict: 'address' });

    if (error) throw error;

    // 2. 更新内存
    this.cache.set(lowerAddr, name);
  },

  // 删除：删 DB + 删 Cache
  async remove(address: string) {
    const lowerAddr = address.toLowerCase();

    const { error } = await supabase
      .from('monitored_wallets')
      .delete()
      .eq('address', lowerAddr);

    if (error) throw error;

    this.cache.delete(lowerAddr);
  }
};
3.2 链上监听模块 (Chain Listener)
监听模块逻辑保持不变，但判断逻辑改为读取 WatchlistStore.cache。

Event Callback:

TypeScript

ctf.on("TransferSingle", (op, from, to, id, val) => {
    // 直接读取内存，零延迟
    const alias = WatchlistStore.cache.get(to.toLowerCase());
    if (alias && val > 0n) {
        processEvent(to, alias, ...);
    }
});
3.3 API 数据丰富模块 (Data Enricher)
逻辑: 接收链上信号 -> 延迟 2s -> 调用 Polymarket API -> 匹配 TRADE & BUY -> 返回清洗后的数据。

新增: 如果 Supabase 连接失败或 API 彻底失败，记录错误日志到 system_logs 表（可选）。

4. 接口定义与交互流程
4.1 Telegram 交互升级
/add <address> <name>:

校验 ETH 地址格式。

调用 WatchlistStore.add(address, name)。

await 等待 Supabase 返回成功。

回复用户：“✅ 已添加监控：[name]”。

(异常处理): 若 Supabase 报错（如网络问题），回复“❌ 数据库连接失败，请稍后重试”。

/list:

直接读取 WatchlistStore.cache（内存读取，极快）。

格式化为列表文本返回。

5. 项目目录结构
Plaintext

polymarket-bot/
├── .env                  # 包含 SUPABASE_URL, SUPABASE_KEY
├── package.json
├── src/
│   ├── index.ts          # 入口：await WatchlistStore.init() -> 启动 Bot/Listener
│   ├── config.ts
│   ├── db/
│   │   └── supabase.ts   # Supabase Client 初始化 & Cache 逻辑
│   ├── services/
│   │   ├── bot.ts        # Telegram 指令处理
│   │   ├── listener.ts   # Ethers 监听
│   │   └── api.ts        # Polymarket API 请求
│   └── utils/
│       └── formatter.ts
6. 部署步骤 (Deployment)
Supabase 设置:

登录 Supabase Dashboard，新建 Project。

进入 SQL Editor，粘贴并运行本文档 2.1 节的 SQL 语句。

在 Project Settings -> API 中获取 URL 和 anon (public) key。

安装依赖:

Bash

npm install @supabase/supabase-js
构建与运行:

确保 .env 文件填写正确。

npm run build && npm start。

观察控制台日志：Loaded X wallets from Supabase 即表示连接成功。
```
